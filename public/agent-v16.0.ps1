# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ATLAS Agent v16.0 - ROLLBACK AUTOMATIQUE INTELLIGENT  
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# - Syst√®me de rollback multi-niveaux
# - Snapshots automatiques avant changements
# - Validation post-d√©ploiement
# - Restauration automatique si √©chec
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

$script:Version = "16.0"
$script:SafeVersion = "13.6"  # Version stable de fallback
$hostname = $env:COMPUTERNAME
$atlasPath = "C:\SYAGA-ATLAS"

# Configuration SharePoint
$tenantId = "6027d81c-ad9b-48f5-9da6-96f1bad11429"
$clientId = "f7c4f1b2-3380-4e87-961f-09922ec452b4"
$clientSecretB64 = "Z3Y0OFF+NHRkakY2RE9td1ZXSS5UdXJNcVcwaGJZZEpGRS5aeWFvaw=="
$clientSecret = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($clientSecretB64))
$siteName = "syagacons"
$serversListId = "94dc7ad4-740f-4c1f-b99c-107e01c8f70b"

# Buffer logs et historique
$script:LogsBuffer = ""
$script:MaxBufferSize = 10000
$script:DeploymentHistory = @()
$script:ValidationResults = @()

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SYST√àME DE ROLLBACK v16.0
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$script:RollbackConfig = @{
    MaxBackups = 5
    BackupPath = "$atlasPath\rollback"
    StateFile = "$atlasPath\deployment-state.json"
    ValidationTimeout = 300  # 5 minutes
}

$script:DeploymentState = @{
    CurrentVersion = $script:Version
    LastStableVersion = $script:SafeVersion
    DeploymentTime = $null
    ValidationStatus = "PENDING"
    RollbackCount = 0
    FailureHistory = @()
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# SNAPSHOT ET BACKUP
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Create-Snapshot {
    param($Description = "Auto-snapshot")
    
    Write-Log "üì∏ Cr√©ation snapshot: $Description" "INFO"
    
    $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
    $snapshotPath = "$($script:RollbackConfig.BackupPath)\snapshot-$timestamp"
    
    try {
        # Cr√©er dossier backup si n√©cessaire
        if (!(Test-Path $script:RollbackConfig.BackupPath)) {
            New-Item -ItemType Directory -Path $script:RollbackConfig.BackupPath -Force | Out-Null
        }
        
        # Cr√©er snapshot
        New-Item -ItemType Directory -Path $snapshotPath -Force | Out-Null
        
        # Sauvegarder √©tat syst√®me
        $systemState = @{
            Version = $script:Version
            Timestamp = $timestamp
            Description = $Description
            Services = Get-ServiceStates
            Processes = Get-ProcessSnapshot
            Registry = Get-RegistrySnapshot
            Files = @()
        }
        
        # Sauvegarder fichiers ATLAS
        $filesToBackup = @(
            "$atlasPath\agent.ps1",
            "$atlasPath\updater.ps1",
            "$atlasPath\config.json"
        )
        
        foreach ($file in $filesToBackup) {
            if (Test-Path $file) {
                $fileName = Split-Path $file -Leaf
                Copy-Item $file "$snapshotPath\$fileName" -Force
                $systemState.Files += $fileName
            }
        }
        
        # Sauvegarder configuration IIS si pr√©sent
        if (Get-Service W3SVC -ErrorAction SilentlyContinue) {
            & appcmd add backup "$timestamp-atlas" 2>&1 | Out-Null
            $systemState.IISBackup = "$timestamp-atlas"
        }
        
        # Sauvegarder √©tat en JSON
        $systemState | ConvertTo-Json -Depth 10 | 
            Set-Content "$snapshotPath\state.json" -Encoding UTF8
        
        # Nettoyer anciens backups
        Clean-OldSnapshots
        
        Write-Log "‚úÖ Snapshot cr√©√©: $snapshotPath" "SUCCESS"
        return $snapshotPath
        
    } catch {
        Write-Log "‚ùå √âchec cr√©ation snapshot: $_" "ERROR"
        return $null
    }
}

function Restore-Snapshot {
    param($SnapshotPath)
    
    Write-Log "üîÑ Restauration snapshot: $SnapshotPath" "WARNING"
    
    try {
        if (!(Test-Path "$SnapshotPath\state.json")) {
            throw "Snapshot invalide: state.json manquant"
        }
        
        $state = Get-Content "$SnapshotPath\state.json" -Raw | ConvertFrom-Json
        
        # Restaurer fichiers
        foreach ($file in $state.Files) {
            $source = "$SnapshotPath\$file"
            $dest = "$atlasPath\$file"
            
            if (Test-Path $source) {
                Copy-Item $source $dest -Force
                Write-Log "  ‚úì Restaur√©: $file" "SUCCESS"
            }
        }
        
        # Restaurer IIS si n√©cessaire
        if ($state.IISBackup) {
            & appcmd restore backup $state.IISBackup 2>&1 | Out-Null
            Write-Log "  ‚úì IIS restaur√©" "SUCCESS"
        }
        
        # Red√©marrer services critiques
        Restore-Services $state.Services
        
        # Mettre √† jour √©tat
        $script:DeploymentState.CurrentVersion = $state.Version
        $script:DeploymentState.RollbackCount++
        Save-DeploymentState
        
        Write-Log "‚úÖ Rollback compl√©t√© vers v$($state.Version)" "SUCCESS"
        return $true
        
    } catch {
        Write-Log "‚ùå √âchec rollback: $_" "ERROR"
        return $false
    }
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# VALIDATION POST-D√âPLOIEMENT
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Validate-Deployment {
    Write-Log "üîç Validation d√©ploiement v$($script:Version)..." "INFO"
    
    $validation = @{
        Timestamp = Get-Date
        Version = $script:Version
        Tests = @()
        Score = 100
        Passed = $true
    }
    
    # Test 1: Agent r√©pond
    $test1 = Test-AgentResponsive
    $validation.Tests += $test1
    if (!$test1.Passed) { $validation.Score -= 30 }
    
    # Test 2: Services critiques
    $test2 = Test-CriticalServices
    $validation.Tests += $test2
    if (!$test2.Passed) { $validation.Score -= 25 }
    
    # Test 3: SharePoint connectivit√©
    $test3 = Test-SharePointConnection
    $validation.Tests += $test3
    if (!$test3.Passed) { $validation.Score -= 20 }
    
    # Test 4: M√©triques syst√®me
    $test4 = Test-SystemMetrics
    $validation.Tests += $test4
    if (!$test4.Passed) { $validation.Score -= 15 }
    
    # Test 5: Pas d'erreurs critiques
    $test5 = Test-NoErrors
    $validation.Tests += $test5
    if (!$test5.Passed) { $validation.Score -= 10 }
    
    # D√©terminer r√©sultat
    $validation.Passed = $validation.Score -ge 70
    
    if ($validation.Passed) {
        Write-Log "‚úÖ Validation r√©ussie (Score: $($validation.Score)/100)" "SUCCESS"
        $script:DeploymentState.ValidationStatus = "PASSED"
    } else {
        Write-Log "‚ùå Validation √©chou√©e (Score: $($validation.Score)/100)" "ERROR"
        $script:DeploymentState.ValidationStatus = "FAILED"
        
        # Ajouter √† l'historique d'√©checs
        $script:DeploymentState.FailureHistory += @{
            Version = $script:Version
            Timestamp = Get-Date
            Score = $validation.Score
            FailedTests = ($validation.Tests | Where-Object {!$_.Passed} | ForEach-Object {$_.Name})
        }
    }
    
    $script:ValidationResults += $validation
    Save-DeploymentState
    
    return $validation
}

function Test-AgentResponsive {
    $test = @{
        Name = "Agent Responsive"
        Passed = $false
        Details = ""
    }
    
    try {
        # V√©rifier que l'agent peut ex√©cuter des commandes
        $result = & powershell -Command "echo 'test'" 2>&1
        if ($result -eq "test") {
            $test.Passed = $true
            $test.Details = "Agent r√©pond correctement"
        } else {
            $test.Details = "Agent ne r√©pond pas"
        }
    } catch {
        $test.Details = "Erreur test: $_"
    }
    
    return $test
}

function Test-CriticalServices {
    $test = @{
        Name = "Critical Services"
        Passed = $true
        Details = @()
    }
    
    $criticalServices = @("W3SVC", "MSSQLSERVER", "VeeamBackupSvc")
    
    foreach ($svc in $criticalServices) {
        $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
        if ($service -and $service.Status -ne "Running" -and $service.StartType -eq "Automatic") {
            $test.Passed = $false
            $test.Details += "$svc is stopped"
        }
    }
    
    if ($test.Passed) {
        $test.Details = "All critical services running"
    }
    
    return $test
}

function Test-SharePointConnection {
    $test = @{
        Name = "SharePoint Connection"
        Passed = $false
        Details = ""
    }
    
    try {
        $tokenBody = @{
            grant_type = "client_credentials"
            client_id = "$clientId@$tenantId"
            client_secret = $clientSecret
            resource = "00000003-0000-0ff1-ce00-000000000000/${siteName}.sharepoint.com@$tenantId"
        }
        
        $tokenResponse = Invoke-RestMethod -Uri "https://accounts.accesscontrol.windows.net/$tenantId/tokens/OAuth/2" `
            -Method POST -Body $tokenBody -ContentType "application/x-www-form-urlencoded" `
            -TimeoutSec 10
        
        if ($tokenResponse.access_token) {
            $test.Passed = $true
            $test.Details = "SharePoint connection OK"
        }
    } catch {
        $test.Details = "SharePoint connection failed: $_"
    }
    
    return $test
}

function Test-SystemMetrics {
    $test = @{
        Name = "System Metrics"
        Passed = $true
        Details = @()
    }
    
    # CPU
    $cpu = (Get-Counter '\Processeur(_Total)\% temps processeur' -ErrorAction SilentlyContinue).CounterSamples[0].CookedValue
    if ($cpu -gt 95) {
        $test.Passed = $false
        $test.Details += "CPU critical: $([math]::Round($cpu,1))%"
    }
    
    # Memory
    $os = Get-WmiObject Win32_OperatingSystem
    $memUsage = (($os.TotalVisibleMemorySize - $os.FreePhysicalMemory) / $os.TotalVisibleMemorySize) * 100
    if ($memUsage -gt 95) {
        $test.Passed = $false
        $test.Details += "Memory critical: $([math]::Round($memUsage,1))%"
    }
    
    # Disk
    $disk = Get-WmiObject Win32_LogicalDisk -Filter "DeviceID='C:'"
    $diskFreeGB = [math]::Round($disk.FreeSpace / 1GB, 1)
    if ($diskFreeGB -lt 5) {
        $test.Passed = $false
        $test.Details += "Disk critical: ${diskFreeGB}GB free"
    }
    
    if ($test.Passed) {
        $test.Details = "System metrics normal"
    }
    
    return $test
}

function Test-NoErrors {
    $test = @{
        Name = "No Critical Errors"
        Passed = $true
        Details = ""
    }
    
    $errors = Get-EventLog -LogName System -EntryType Error -After (Get-Date).AddMinutes(-5) -ErrorAction SilentlyContinue
    if ($errors -and $errors.Count -gt 10) {
        $test.Passed = $false
        $test.Details = "$($errors.Count) system errors in last 5 minutes"
    } else {
        $test.Details = "No critical errors detected"
    }
    
    return $test
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# ROLLBACK AUTOMATIQUE
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Perform-AutoRollback {
    Write-Log "üö® ROLLBACK AUTOMATIQUE D√âCLENCH√â" "WARNING"
    
    # Chercher dernier snapshot valide
    $snapshots = Get-ChildItem "$($script:RollbackConfig.BackupPath)\snapshot-*" -Directory -ErrorAction SilentlyContinue |
                 Sort-Object Name -Descending
    
    if ($snapshots.Count -eq 0) {
        Write-Log "‚ùå Aucun snapshot disponible pour rollback" "ERROR"
        
        # Fallback vers version stable connue
        Write-Log "üîÑ Tentative fallback vers v$($script:SafeVersion)..." "WARNING"
        Download-SafeVersion
        return
    }
    
    # Essayer chaque snapshot jusqu'√† r√©ussite
    foreach ($snapshot in $snapshots) {
        Write-Log "  Tentative avec: $($snapshot.Name)" "INFO"
        
        if (Restore-Snapshot $snapshot.FullName) {
            # Valider apr√®s restauration
            Start-Sleep -Seconds 5
            $postValidation = Validate-Deployment
            
            if ($postValidation.Passed) {
                Write-Log "‚úÖ Rollback r√©ussi et valid√©" "SUCCESS"
                Send-RollbackNotification "SUCCESS" $snapshot.Name
                return $true
            }
        }
    }
    
    Write-Log "‚ùå Tous les rollbacks ont √©chou√©" "ERROR"
    Send-RollbackNotification "FAILED" "All attempts"
    return $false
}

function Download-SafeVersion {
    try {
        Write-Log "üì• T√©l√©chargement version stable v$($script:SafeVersion)..." "INFO"
        
        $baseUrl = "https://white-river-053fc6703.2.azurestaticapps.net/public"
        $agentUrl = "$baseUrl/agent-v$($script:SafeVersion).ps1"
        
        Invoke-WebRequest -Uri $agentUrl -OutFile "$atlasPath\agent.ps1" -UseBasicParsing
        
        Write-Log "‚úÖ Version stable install√©e" "SUCCESS"
        
        # Forcer red√©marrage
        Restart-Service "SYAGA-ATLAS-Agent" -Force -ErrorAction SilentlyContinue
        
    } catch {
        Write-Log "‚ùå Impossible de t√©l√©charger version stable: $_" "ERROR"
    }
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# HELPERS
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Get-ServiceStates {
    $services = @{}
    $critical = @("W3SVC", "MSSQLSERVER", "MSExchangeIS", "vmms", "VeeamBackupSvc")
    
    foreach ($svc in $critical) {
        $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
        if ($service) {
            $services[$svc] = @{
                Status = $service.Status.ToString()
                StartType = $service.StartType.ToString()
            }
        }
    }
    
    return $services
}

function Get-ProcessSnapshot {
    Get-Process | Select-Object -First 10 Name, Id, WorkingSet64, CPU |
        ForEach-Object {
            @{
                Name = $_.Name
                PID = $_.Id
                MemoryMB = [math]::Round($_.WorkingSet64 / 1MB, 1)
            }
        }
}

function Get-RegistrySnapshot {
    # Snapshot cl√©s registry importantes
    @{
        ATLASVersion = (Get-ItemProperty "HKLM:\SOFTWARE\SYAGA\ATLAS" -Name Version -ErrorAction SilentlyContinue).Version
        WindowsVersion = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion" -Name ReleaseId).ReleaseId
    }
}

function Restore-Services($ServiceStates) {
    foreach ($svc in $ServiceStates.Keys) {
        $currentService = Get-Service -Name $svc -ErrorAction SilentlyContinue
        if ($currentService) {
            if ($ServiceStates[$svc].Status -eq "Running" -and $currentService.Status -ne "Running") {
                Start-Service -Name $svc -ErrorAction SilentlyContinue
                Write-Log "  ‚úì Service red√©marr√©: $svc" "SUCCESS"
            }
        }
    }
}

function Clean-OldSnapshots {
    $snapshots = Get-ChildItem "$($script:RollbackConfig.BackupPath)\snapshot-*" -Directory -ErrorAction SilentlyContinue |
                 Sort-Object Name -Descending
    
    if ($snapshots.Count -gt $script:RollbackConfig.MaxBackups) {
        $toDelete = $snapshots | Select-Object -Skip $script:RollbackConfig.MaxBackups
        foreach ($old in $toDelete) {
            Remove-Item $old.FullName -Recurse -Force -ErrorAction SilentlyContinue
            Write-Log "  Supprim√© ancien snapshot: $($old.Name)" "DEBUG"
        }
    }
}

function Save-DeploymentState {
    try {
        $script:DeploymentState | ConvertTo-Json -Depth 10 |
            Set-Content $script:RollbackConfig.StateFile -Encoding UTF8
    } catch {
        Write-Log "Erreur sauvegarde √©tat: $_" "WARNING"
    }
}

function Load-DeploymentState {
    if (Test-Path $script:RollbackConfig.StateFile) {
        try {
            $script:DeploymentState = Get-Content $script:RollbackConfig.StateFile -Raw | ConvertFrom-Json
        } catch {
            Write-Log "Erreur chargement √©tat: $_" "WARNING"
        }
    }
}

function Send-RollbackNotification($Status, $Details) {
    try {
        # Envoyer notification √† SharePoint
        $notification = @{
            Type = "ROLLBACK"
            Status = $Status
            Version = $script:Version
            Details = $Details
            Timestamp = Get-Date
            Server = $hostname
        }
        
        # Log local pour l'instant
        Write-Log "üìß Notification rollback: $Status - $Details" "INFO"
        
    } catch {
        Write-Log "Erreur notification: $_" "WARNING"
    }
}

function Write-Log {
    param($Message, $Level = "INFO")
    $timestamp = Get-Date -Format "HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    
    $script:LogsBuffer += "$logEntry`r`n"
    if ($script:LogsBuffer.Length -gt $script:MaxBufferSize) {
        $script:LogsBuffer = $script:LogsBuffer.Substring($script:LogsBuffer.Length - $script:MaxBufferSize)
    }
    
    switch($Level) {
        "ERROR" { Write-Host $logEntry -ForegroundColor Red }
        "WARNING" { Write-Host $logEntry -ForegroundColor Yellow }
        "SUCCESS" { Write-Host $logEntry -ForegroundColor Green }
        "UPDATE" { Write-Host $logEntry -ForegroundColor Magenta }
        "DEBUG" { Write-Host $logEntry -ForegroundColor DarkGray }
        default { Write-Host $logEntry }
    }
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# HEARTBEAT v16.0 AVEC ROLLBACK
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function Send-Heartbeat {
    try {
        Write-Log "Pr√©paration heartbeat v$($script:Version) avec rollback..." "DEBUG"
        
        # Token SharePoint
        $tokenBody = @{
            grant_type = "client_credentials"
            client_id = "$clientId@$tenantId"
            client_secret = $clientSecret
            resource = "00000003-0000-0ff1-ce00-000000000000/${siteName}.sharepoint.com@$tenantId"
        }
        
        $tokenResponse = Invoke-RestMethod -Uri "https://accounts.accesscontrol.windows.net/$tenantId/tokens/OAuth/2" `
            -Method POST -Body $tokenBody -ContentType "application/x-www-form-urlencoded"
        
        $token = $tokenResponse.access_token
        
        $headers = @{
            "Authorization" = "Bearer $token"
            "Accept" = "application/json;odata=verbose"
            "Content-Type" = "application/json;odata=verbose;charset=utf-8"
        }
        
        # M√©triques
        $cpu = (Get-Counter '\Processeur(_Total)\% temps processeur' -ErrorAction SilentlyContinue).CounterSamples[0].CookedValue
        $os = Get-WmiObject Win32_OperatingSystem
        $memUsage = (($os.TotalVisibleMemorySize - $os.FreePhysicalMemory) / $os.TotalVisibleMemorySize) * 100
        $disk = Get-WmiObject Win32_LogicalDisk -Filter "DeviceID='C:'"
        $diskFreeGB = [math]::Round($disk.FreeSpace / 1GB, 1)
        
        # IP
        $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notmatch "Loopback"} | Select-Object -First 1).IPAddress
        
        # Rapport rollback
        $rollbackReport = if ($script:DeploymentState.RollbackCount -gt 0) {
            "`r`nüîÑ ROLLBACK INFO:`r`n" +
            "  Rollbacks: $($script:DeploymentState.RollbackCount)`r`n" +
            "  Current: v$($script:DeploymentState.CurrentVersion)`r`n" +
            "  Last Stable: v$($script:DeploymentState.LastStableVersion)`r`n" +
            "  Validation: $($script:DeploymentState.ValidationStatus)"
        } else { "" }
        
        # Validation report
        $validationReport = if ($script:ValidationResults.Count -gt 0) {
            $last = $script:ValidationResults[-1]
            "`r`n‚úÖ VALIDATION:`r`n" +
            "  Score: $($last.Score)/100`r`n" +
            "  Tests: $($last.Tests.Count) ($(@($last.Tests | Where-Object {$_.Passed}).Count) passed)"
        } else { "" }
        
        $currentTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $logHeader = @"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ATLAS v$($script:Version) - ROLLBACK INTELLIGENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Hostname: $hostname ($ip)
Time: $currentTime

M√âTRIQUES:
  CPU: $([math]::Round($cpu,1))%
  Memory: $([math]::Round($memUsage,1))%
  Disk C:\: $diskFreeGB GB free

$rollbackReport
$validationReport

LOGS R√âCENTS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"@
        
        # Ajouter logs
        $enrichedLogs = $logHeader + "`r`n" + $script:LogsBuffer
        if ($enrichedLogs.Length -gt 8000) {
            $enrichedLogs = $enrichedLogs.Substring(0, 8000) + "`r`n... (tronqu√©)"
        }
        
        # D√©terminer √©tat
        $globalState = if ($script:DeploymentState.ValidationStatus -eq "FAILED") { "ROLLBACK" }
                      elseif ($script:DeploymentState.RollbackCount -gt 2) { "UNSTABLE" }
                      else { "HEALTHY" }
        
        # Donn√©es SharePoint
        $data = @{
            "__metadata" = @{ type = "SP.Data.ATLASServersListItem" }
            Title = $hostname
            Hostname = $hostname
            IPAddress = $ip
            State = $globalState
            LastContact = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd'T'HH:mm:ss'Z'")
            AgentVersion = $script:Version
            CPUUsage = [math]::Round($cpu, 1)
            MemoryUsage = [math]::Round($memUsage, 1)
            DiskSpaceGB = $diskFreeGB
            Logs = $enrichedLogs
        }
        
        $jsonData = $data | ConvertTo-Json -Depth 10
        
        # Envoyer √† SharePoint
        Write-Log "Envoi heartbeat v16.0 avec rollback status..." "DEBUG"
        $createUrl = "https://${siteName}.sharepoint.com/_api/web/lists(guid'$serversListId')/items"
        $response = Invoke-RestMethod -Uri $createUrl -Headers $headers -Method POST -Body $jsonData
        
        Write-Log "Heartbeat v16.0 envoy√© (√âtat: $globalState)" "SUCCESS"
        
    } catch {
        Write-Log "Erreur heartbeat: $_" "ERROR"
    }
}

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# MAIN v16.0
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Write-Log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "INFO"
Write-Log "ATLAS v$($script:Version) - ROLLBACK INTELLIGENT" "SUCCESS"
Write-Log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "INFO"

# Charger √©tat pr√©c√©dent
Load-DeploymentState

# Si premi√®re ex√©cution de cette version
if ($script:DeploymentState.CurrentVersion -ne $script:Version) {
    Write-Log "üÜï Nouveau d√©ploiement d√©tect√©" "UPDATE"
    
    # Cr√©er snapshot avant changements
    $snapshot = Create-Snapshot "Pre-v$($script:Version)"
    
    # Mettre √† jour √©tat
    $script:DeploymentState.CurrentVersion = $script:Version
    $script:DeploymentState.DeploymentTime = Get-Date
    $script:DeploymentState.ValidationStatus = "PENDING"
    Save-DeploymentState
    
    # Attendre un peu avant validation
    Write-Log "‚è≥ Attente stabilisation (10 secondes)..." "INFO"
    Start-Sleep -Seconds 10
    
    # Valider d√©ploiement
    $validation = Validate-Deployment
    
    if (!$validation.Passed) {
        Write-Log "‚ùå Validation √©chou√©e - Rollback n√©cessaire" "ERROR"
        Perform-AutoRollback
    }
}

# Envoyer heartbeat
Send-Heartbeat

Write-Log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "INFO"
Write-Log "ATLAS v$($script:Version) TERMIN√â" "SUCCESS"
Write-Log "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "INFO"

exit 0