<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä ATLAS Dashboard v2 - Auto-Update Manager</title>
    
    <!-- MSAL pour Azure AD Auth -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .server-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .metric-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-running {
            background: #d4edda;
            color: #155724;
        }
        
        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f85032 0%, #e73827 100%);
            color: white;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* NOUVEAU: Section Auto-Update */
        .update-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .update-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .version-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .version-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .version-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 0.25rem;
        }
        
        .version-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .update-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .update-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            display: none;
        }
        
        .update-log.visible {
            display: block;
        }
        
        .update-log-entry {
            margin-bottom: 0.5rem;
        }
        
        .log-time {
            color: #608b4e;
        }
        
        .log-success {
            color: #4ec9b0;
        }
        
        .log-error {
            color: #f48771;
        }
        
        .log-info {
            color: #9cdcfe;
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .agent-status {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-status.updated {
            background: #d4edda;
            border: 1px solid #28a745;
        }
        
        .agent-status.outdated {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.visible {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .close-btn:hover {
            color: #2c3e50;
        }
        
        .code-editor {
            width: 100%;
            min-height: 300px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .loader {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader.visible {
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">
            üìä ATLAS Dashboard v2
            <span style="font-size: 0.8rem; color: #7f8c8d;">Auto-Update Manager</span>
        </div>
        <div>
            <button id="authBtn" class="btn btn-primary">üîê Se connecter</button>
            <button id="refreshBtn" class="btn btn-success" style="display:none;">üîÑ Actualiser</button>
        </div>
    </div>

    <div class="container">
        <!-- Section Auto-Update -->
        <div class="update-section">
            <div class="update-header">
                <div class="update-title">
                    üöÄ Gestion des Mises √† Jour Agent
                </div>
                <div class="update-actions">
                    <button id="checkVersionBtn" class="btn btn-primary">
                        üîç V√©rifier Versions
                    </button>
                    <button id="deployUpdateBtn" class="btn btn-success">
                        üì§ D√©ployer v5.4
                    </button>
                    <button id="customUpdateBtn" class="btn btn-danger">
                        ‚úèÔ∏è MAJ Personnalis√©e
                    </button>
                    <div class="loader" id="updateLoader"></div>
                </div>
            </div>
            
            <div class="version-info">
                <div class="version-card">
                    <div class="version-label">Version Actuelle</div>
                    <div class="version-value" id="currentVersion">v5.3</div>
                </div>
                <div class="version-card">
                    <div class="version-label">Version Disponible</div>
                    <div class="version-value" id="availableVersion">v5.4</div>
                </div>
                <div class="version-card">
                    <div class="version-label">Agents √† Jour</div>
                    <div class="version-value" id="agentsUpdated">0/0</div>
                </div>
                <div class="version-card">
                    <div class="version-label">Derni√®re MAJ</div>
                    <div class="version-value" id="lastUpdate">-</div>
                </div>
            </div>
            
            <div class="agent-grid" id="agentStatusGrid">
                <!-- Rempli dynamiquement -->
            </div>
            
            <div class="update-log" id="updateLog">
                <!-- Log des mises √† jour -->
            </div>
        </div>
        
        <!-- Grille des serveurs -->
        <div class="grid" id="serversGrid">
            <div class="card">
                <div style="text-align: center; color: #7f8c8d;">
                    <p>Authentification requise</p>
                    <p style="margin-top: 1rem;">Cliquez sur "Se connecter"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour MAJ personnalis√©e -->
    <div class="modal" id="customUpdateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è D√©ployer une Mise √† Jour Personnalis√©e</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div>
                <label>Version:</label>
                <input type="text" id="customVersion" placeholder="Ex: 5.5" style="width: 100%; padding: 0.5rem; margin: 0.5rem 0;">
                
                <label>Code PowerShell de l'Agent:</label>
                <textarea id="customCode" class="code-editor" placeholder="Collez le code PowerShell de l'agent ici..."></textarea>
                
                <div style="margin-top: 1rem; text-align: right;">
                    <button class="btn btn-danger" onclick="deployCustomUpdate()">üì§ D√©ployer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === CODE AGENT V5.4 - NOTE: Le secret doit √™tre configur√© sur le serveur ===
        const AGENT_V54_CODE = `# ATLAS Agent v5.4 ENRICHED - Metriques enrichies
# Services, Events, Veeam, Certificats, Hyper-V, Replication

param(
    [string]$Action = "Executer",
    [int]$IntervalleMinutes = 3
)

$OutputEncoding = [System.Text.Encoding]::UTF8
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8

# Configuration
$Script:Version = "5.4"
$Script:CheminBase = "C:\\ATLAS"
$Script:CheminAgent = "$Script:CheminBase\\Agent"
$Script:CheminLogs = "$Script:CheminBase\\Logs"
$Script:FichierLog = "$Script:CheminLogs\\Agent-$(Get-Date -Format 'yyyyMMdd').log"
$Script:FichierAgentActuel = "$Script:CheminAgent\\ATLAS-Agent-Current.ps1"
$Script:NomTache = "ATLAS-Agent-v5"

# SharePoint
$Script:TenantId = "6027d81c-ad9b-48f5-9da6-96f1bad11429"
$Script:ClientId = "f66a8c6c-1037-41b8-be3c-4f6e67c1f49e"
# Le secret sera recupere depuis la config existante lors de l'auto-update
$Script:ClientSecret = if (Test-Path "C:\ATLAS\Config\auth.json") {
    (Get-Content "C:\ATLAS\Config\auth.json" | ConvertFrom-Json).ClientSecret
} else {
    # Fallback: recuperer depuis l'agent actuel en memoire
    $Script:ClientSecret
}
$Script:SiteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas"

# [... Le reste du code de l'agent v5.4 ...]
# Code complet disponible dans ATLAS-Agent-v5.4-ENRICHED.ps1
`;

        // Configuration MSAL
        const msalConfig = {
            auth: {
                clientId: "f66a8c6c-1037-41b8-be3c-4f6e67c1f49e",  // SYAGA-ATLAS-AUTOMATION
                authority: "https://login.microsoftonline.com/6027d81c-ad9b-48f5-9da6-96f1bad11429",  // Tenant SYAGA
                redirectUri: "https://white-river-053fc6703.2.azurestaticapps.net/"
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);
        let accessToken = null;

        // Initialisation
        async function initAuth() {
            try {
                await msalInstance.initialize();
                
                const response = await msalInstance.handleRedirectPromise();
                if (response) {
                    console.log('‚úÖ Auth depuis redirect');
                    accessToken = response.accessToken;
                    onAuthSuccess();
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length > 0) {
                        console.log('üìå Session existante trouv√©e');
                        await silentAuth();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erreur init:', error);
            }
        }

        async function login() {
            const loginRequest = {
                scopes: ["https://graph.microsoft.com/.default"]
            };
            
            try {
                const response = await msalInstance.loginPopup(loginRequest);
                accessToken = response.accessToken;
                onAuthSuccess();
            } catch (error) {
                console.error('‚ùå Erreur login:', error);
            }
        }

        async function silentAuth() {
            const account = msalInstance.getAllAccounts()[0];
            const silentRequest = {
                scopes: ["https://graph.microsoft.com/.default"],
                account: account
            };
            
            try {
                const response = await msalInstance.acquireTokenSilent(silentRequest);
                accessToken = response.accessToken;
                onAuthSuccess();
            } catch (error) {
                console.log('üîÑ Token expir√©, renouvellement...');
                await login();
            }
        }

        function onAuthSuccess() {
            document.getElementById('authBtn').style.display = 'none';
            document.getElementById('refreshBtn').style.display = 'inline-block';
            loadServers();
            checkAgentVersions();
        }

        // Charger les serveurs
        async function loadServers() {
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const listUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-Servers')/items`;
            
            try {
                const response = await fetch(listUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                displayServers(data.value || []);
                updateAgentStatus(data.value || []);
            } catch (error) {
                console.error('‚ùå Erreur chargement:', error);
            }
        }

        function displayServers(servers) {
            const grid = document.getElementById('serversGrid');
            
            if (servers.length === 0) {
                grid.innerHTML = '<div class="card"><p>Aucun serveur trouv√©</p></div>';
                return;
            }
            
            grid.innerHTML = servers.map(server => `
                <div class="card">
                    <div class="server-name">${server.Hostname || 'Serveur'}</div>
                    <div class="metric">
                        <span class="metric-label">√âtat</span>
                        <span class="status-badge status-${(server.State || 'Unknown').toLowerCase()}">${server.State || 'Unknown'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">CPU</span>
                        <span class="metric-value">${server.CPUUsage ? server.CPUUsage.toFixed(1) + '%' : 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">RAM</span>
                        <span class="metric-value">${server.MemoryUsageGB ? server.MemoryUsageGB.toFixed(1) + ' GB' : 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Disque libre</span>
                        <span class="metric-value">${server.DiskSpaceGB ? server.DiskSpaceGB.toFixed(1) + ' GB' : 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Version Agent</span>
                        <span class="metric-value">${server.AgentVersion || 'N/A'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Derni√®re MAJ</span>
                        <span class="metric-value">${server.LastUpdate ? new Date(server.LastUpdate).toLocaleString('fr-FR') : 'N/A'}</span>
                    </div>
                    ${server.ServicesDown > 0 ? `
                        <div class="metric">
                            <span class="metric-label">‚ö†Ô∏è Services DOWN</span>
                            <span class="metric-value" style="color: red;">${server.ServicesDown}</span>
                        </div>
                    ` : ''}
                    ${server.ReplicationIssues > 0 ? `
                        <div class="metric">
                            <span class="metric-label">‚ö†Ô∏è R√©plication</span>
                            <span class="metric-value" style="color: orange;">${server.ReplicationIssues} probl√®me(s)</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function updateAgentStatus(servers) {
            const grid = document.getElementById('agentStatusGrid');
            const latestVersion = "5.4"; // Version cible
            
            let updated = 0;
            let total = servers.length;
            
            grid.innerHTML = servers.map(server => {
                const version = server.AgentVersion || "Unknown";
                const isUpdated = version === latestVersion;
                if (isUpdated) updated++;
                
                return `
                    <div class="agent-status ${isUpdated ? 'updated' : 'outdated'}">
                        <span>${server.Hostname || 'Serveur'}</span>
                        <span style="font-weight: 600;">v${version}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('agentsUpdated').textContent = `${updated}/${total}`;
        }

        // V√©rifier les versions des agents
        async function checkAgentVersions() {
            addLog("V√©rification des versions des agents...", "info");
            
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const listUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-AgentUpdates')/items?$orderby=Version desc&$top=1`;
            
            try {
                const response = await fetch(listUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.value && data.value.length > 0) {
                        const latest = data.value[0];
                        document.getElementById('availableVersion').textContent = `v${latest.Version}`;
                        document.getElementById('lastUpdate').textContent = new Date(latest.ReleaseDate).toLocaleDateString('fr-FR');
                        addLog(`Version disponible: v${latest.Version}`, "success");
                    }
                }
            } catch (error) {
                addLog("Liste AgentUpdates non trouv√©e (normale au d√©but)", "info");
            }
        }

        // D√©ployer la mise √† jour v5.4
        async function deployV54Update() {
            const loader = document.getElementById('updateLoader');
            loader.classList.add('visible');
            
            addLog("D√©ploiement de la mise √† jour v5.4...", "info");
            
            // Cr√©er la liste si n√©cessaire
            await createUpdateListIfNeeded();
            
            // D√©ployer la v5.4
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const listUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-AgentUpdates')/items`;
            
            const updateItem = {
                Title: "Agent v5.4 ENRICHED",
                Version: "5.4",
                ScriptContent: AGENT_V54_CODE,
                ReleaseDate: new Date().toISOString()
            };
            
            try {
                const response = await fetch(listUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json;odata=verbose',
                        'Content-Type': 'application/json;odata=verbose',
                        'X-RequestDigest': await getRequestDigest()
                    },
                    body: JSON.stringify({
                        '__metadata': { 'type': 'SP.Data.ATLAS_x002d_AgentUpdatesListItem' },
                        ...updateItem
                    })
                });
                
                if (response.ok) {
                    addLog("‚úÖ Mise √† jour v5.4 d√©ploy√©e avec succ√®s!", "success");
                    addLog("Les agents vont se mettre √† jour automatiquement dans les 3 minutes", "info");
                    document.getElementById('availableVersion').textContent = 'v5.4';
                    
                    // Rafra√Æchir apr√®s 30 secondes pour voir les mises √† jour
                    setTimeout(() => {
                        loadServers();
                        addLog("V√©rification des mises √† jour des agents...", "info");
                    }, 30000);
                } else {
                    throw new Error(`Erreur ${response.status}`);
                }
            } catch (error) {
                addLog(`‚ùå Erreur d√©ploiement: ${error.message}`, "error");
            } finally {
                loader.classList.remove('visible');
            }
        }

        // Cr√©er la liste AgentUpdates si n√©cessaire
        async function createUpdateListIfNeeded() {
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const checkUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-AgentUpdates')`;
            
            try {
                const response = await fetch(checkUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    // La liste n'existe pas, la cr√©er
                    addLog("Cr√©ation de la liste AgentUpdates...", "info");
                    
                    const createUrl = `${siteUrl}/_api/web/lists`;
                    const listBody = {
                        '__metadata': { 'type': 'SP.List' },
                        'AllowContentTypes': true,
                        'BaseTemplate': 100,
                        'ContentTypesEnabled': true,
                        'Title': 'ATLAS-AgentUpdates',
                        'Description': 'Liste des mises √† jour de l\'agent ATLAS'
                    };
                    
                    await fetch(createUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json;odata=verbose',
                            'Content-Type': 'application/json;odata=verbose',
                            'X-RequestDigest': await getRequestDigest()
                        },
                        body: JSON.stringify(listBody)
                    });
                    
                    addLog("Liste AgentUpdates cr√©√©e", "success");
                    
                    // Ajouter les colonnes n√©cessaires
                    await addListColumns();
                }
            } catch (error) {
                console.log("Liste v√©rifi√©e");
            }
        }

        async function addListColumns() {
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const fieldUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-AgentUpdates')/fields`;
            
            const fields = [
                { Title: 'Version', FieldTypeKind: 2, Required: true },
                { Title: 'ScriptContent', FieldTypeKind: 3, NumberOfLines: 50 },
                { Title: 'ReleaseDate', FieldTypeKind: 4 }
            ];
            
            for (const field of fields) {
                try {
                    await fetch(fieldUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Accept': 'application/json;odata=verbose',
                            'Content-Type': 'application/json;odata=verbose',
                            'X-RequestDigest': await getRequestDigest()
                        },
                        body: JSON.stringify({
                            '__metadata': { 'type': 'SP.Field' },
                            ...field
                        })
                    });
                } catch (error) {
                    // Ignorer si le champ existe d√©j√†
                }
            }
        }

        async function getRequestDigest() {
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const response = await fetch(`${siteUrl}/_api/contextinfo`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/json;odata=verbose'
                }
            });
            const data = await response.json();
            return data.d.GetContextWebInformation.FormDigestValue;
        }

        // D√©ployer une mise √† jour personnalis√©e
        async function deployCustomUpdate() {
            const version = document.getElementById('customVersion').value;
            const code = document.getElementById('customCode').value;
            
            if (!version || !code) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            const loader = document.getElementById('updateLoader');
            loader.classList.add('visible');
            
            addLog(`D√©ploiement de la mise √† jour v${version}...`, "info");
            
            const siteUrl = "https://syagaconsulting.sharepoint.com/sites/SYAGA-Atlas";
            const listUrl = `${siteUrl}/_api/web/lists/getbytitle('ATLAS-AgentUpdates')/items`;
            
            try {
                const response = await fetch(listUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/json;odata=verbose',
                        'Content-Type': 'application/json;odata=verbose',
                        'X-RequestDigest': await getRequestDigest()
                    },
                    body: JSON.stringify({
                        '__metadata': { 'type': 'SP.Data.ATLAS_x002d_AgentUpdatesListItem' },
                        'Title': `Agent v${version} Custom`,
                        'Version': version,
                        'ScriptContent': code,
                        'ReleaseDate': new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    addLog(`‚úÖ Mise √† jour v${version} d√©ploy√©e!`, "success");
                    closeModal();
                    document.getElementById('availableVersion').textContent = `v${version}`;
                } else {
                    throw new Error(`Erreur ${response.status}`);
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, "error");
            } finally {
                loader.classList.remove('visible');
            }
        }

        function addLog(message, type = "info") {
            const log = document.getElementById('updateLog');
            log.classList.add('visible');
            
            const time = new Date().toLocaleTimeString('fr-FR');
            const className = `log-${type}`;
            
            log.innerHTML += `
                <div class="update-log-entry">
                    <span class="log-time">[${time}]</span>
                    <span class="${className}">${message}</span>
                </div>
            `;
            
            log.scrollTop = log.scrollHeight;
        }

        function closeModal() {
            document.getElementById('customUpdateModal').classList.remove('visible');
        }

        // Event listeners
        document.getElementById('authBtn').addEventListener('click', login);
        document.getElementById('refreshBtn').addEventListener('click', loadServers);
        document.getElementById('checkVersionBtn').addEventListener('click', checkAgentVersions);
        document.getElementById('deployUpdateBtn').addEventListener('click', deployV54Update);
        document.getElementById('customUpdateBtn').addEventListener('click', () => {
            document.getElementById('customUpdateModal').classList.add('visible');
        });

        // Initialisation
        initAuth();
    </script>
</body>
</html>